name: Build & Release APK

on:
  pull_request:
    types: [closed]
    branches: [master, main]

jobs:
  build-and-release:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug --no-daemon

    - name: Build Release APK
      run: ./gradlew assembleRelease --no-daemon

    - name: Get version from build.gradle
      id: version
      run: |
        VERSION_NAME=$(grep -oP 'versionName "\K[^"]+' app/build.gradle)
        VERSION_CODE=$(grep -oP 'versionCode \K\d+' app/build.gradle)
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Version: $VERSION_NAME ($VERSION_CODE)"

    - name: Generate Release Tag
      id: tag
      run: |
        TAG="v${{ steps.version.outputs.version_name }}-build.${{ github.run_number }}"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Tag: $TAG"

    - name: Rename APKs
      run: |
        mv app/build/outputs/apk/debug/app-debug.apk app/build/outputs/apk/debug/materialistic-${{ steps.tag.outputs.tag }}-debug.apk
        mv app/build/outputs/apk/release/app-release-unsigned.apk app/build/outputs/apk/release/materialistic-${{ steps.tag.outputs.tag }}-release.apk 2>/dev/null || true

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "Release ${{ steps.tag.outputs.tag }}"
        body: |
          ## What's Changed
          PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
          
          Merged by: @${{ github.event.pull_request.merged_by.login }}
          
          ---
          
          ### Downloads
          - **Debug APK**: For testing (not optimized)
          - **Release APK**: For production (unsigned - needs signing for Play Store)
          
          ### Build Info
          - Version: ${{ steps.version.outputs.version_name }}
          - Build: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
        files: |
          app/build/outputs/apk/debug/materialistic-${{ steps.tag.outputs.tag }}-debug.apk
          app/build/outputs/apk/release/materialistic-${{ steps.tag.outputs.tag }}-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Also upload APK as artifact for PRs (before merge)
  build-pr-artifact:
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug --no-daemon

    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk-pr-${{ github.event.pull_request.number }}
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7
