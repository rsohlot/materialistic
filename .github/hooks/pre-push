#!/bin/bash

# Pre-push hook for security checks
# To install: cp .github/hooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

echo "üîí Running security checks before push..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# Check for hardcoded secrets/API keys in all staged files
echo "Checking for hardcoded secrets..."
SECRETS_PATTERN='(password|secret|api_key|apikey|token|private_key|credentials)\s*=\s*["\x27][^"\x27]+'
if grep -riE "$SECRETS_PATTERN" --include="*.java" --include="*.kt" --include="*.xml" --include="*.properties" --include="*.gradle" . 2>/dev/null | grep -v "Binary" | grep -v ".git" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Potential hardcoded secrets detected!${NC}"
    grep -riE "$SECRETS_PATTERN" --include="*.java" --include="*.kt" --include="*.xml" --include="*.properties" --include="*.gradle" . 2>/dev/null | grep -v "Binary" | grep -v ".git" | head -5
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No hardcoded secrets found${NC}"
fi

# Check for AWS keys
echo "Checking for AWS keys..."
if grep -rE '(AKIA|ASIA)[A-Z0-9]{16}' --include="*.java" --include="*.kt" --include="*.xml" --include="*.properties" . 2>/dev/null | grep -v ".git" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Potential AWS access key detected!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No AWS keys found${NC}"
fi

# Check for private keys
echo "Checking for private keys..."
if grep -rE 'BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY' . 2>/dev/null | grep -v ".git" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Private key detected!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No private keys found${NC}"
fi

# Check for Google API keys
echo "Checking for Google API keys..."
if grep -rE 'AIza[0-9A-Za-z\\-_]{35}' --include="*.java" --include="*.kt" --include="*.xml" . 2>/dev/null | grep -v ".git" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Potential Google API key detected!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No Google API keys found${NC}"
fi

# Summary
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Security check failed with $ERRORS error(s)${NC}"
    echo "Push blocked. Please fix the issues above."
    echo "To bypass (not recommended): git push --no-verify"
    exit 1
else
    echo -e "${GREEN}‚úì All security checks passed - push allowed${NC}"
    exit 0
fi
